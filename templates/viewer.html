{% extends "base.html" %}
{% block content %}

<div class="relative min-h-screen bg-cover bg-center"
     style="background-image: url('https://playerimages-1.s3.us-east-1.amazonaws.com/backgroundImage-Viewml.jpg');">

  <div class="max-w-7xl mx-auto p-6 relative z-10 grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- LEFT PANEL: Current Player + Teams -->
    <div class="flex flex-col gap-6 overflow-y-auto max-h-screen">

      <!-- ⭐ SPONSORED BY + SPONSOR SLIDESHOW ABOVE PLAYER CARD -->
      <div class="flex flex-col items-center mt-2 mb-4">
        <p class="text-white text-sm md:text-base font-semibold tracking-wide drop-shadow-lg mb-1">
            Sponsored By
        </p>
        <img id="sponsor_rotating"
             class="h-16 md:h-20 object-contain drop-shadow-xl transition-opacity duration-2000"
             src="{{ sponsor_logos[0] }}"
             alt="Sponsor Logo">
      </div>

      <!-- CURRENT PLAYER -->
      <div class="flex flex-col items-center p-4 glass rounded-lg relative">
        <img id="sold_stamp" class="sold-stamp absolute top-2 left-2 w-24 h-24 opacity-0 transition-opacity duration-500"
             src="https://playersauction.s3.ap-south-1.amazonaws.com/SOLD-STAMP.jpg" />
        <img id="player_image" class="w-32 h-32 md:w-48 md:h-48 object-cover rounded-lg mb-4"
             src="{{ default_image_url }}" alt="Player Image">
        <h3 id="player_name" class="text-lg md:text-xl font-semibold text-white">---</h3>
        <p id="player_role" class="text-sm md:text-base text-white">Role: ---</p>
        <p id="player_age" class="text-sm md:text-base text-white">Age: ---</p>
        <p id="player_base_price" class="text-sm md:text-base text-white">Base Price: ---</p>
        <p id="current_bid_display" class="font-semibold text-white">Highest Bid: ---</p>
        <p id="highest_bidder_display" class="text-white">Bid by: ---</p>
      </div>

      <!-- TEAMS GRID (4-Column Tile with Logo + Stats) -->
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-4" id="teams_container">
        <!-- Tiles will be populated by JS -->
      </div>
    </div>

    <!-- RIGHT PANEL: Videos -->
    <div class="flex flex-col gap-4 overflow-y-auto max-h-screen pr-2">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        {% for video_url in video_urls %}
        <video class="w-full rounded-lg" src="{{ video_url }}" muted autoplay loop playsinline></video>
        {% endfor %}
      </div>
    </div>

  </div>

  <!-- SOLD MODAL -->
  <div id="sold_modal"
       class="fixed inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-500">
    <div class="bg-white p-6 rounded-lg text-center relative shadow-lg max-w-sm w-full">
      <img id="sold_player_image" class="w-32 h-32 rounded mb-4 mx-auto" src="" alt="Player Image">
      <h2 id="sold_text" class="text-2xl font-bold text-green-600 mb-2">PLAYER SOLD</h2>
      <p id="sold_team" class="text-2xl font-bold text-green-600 mb-2"></p>
      <p id="sold_price" class="text-lg font-semibold text-gray-800"></p>
      <img id="sold_team_logo" class="w-20 h-20 mx-auto mt-2 hidden" src="" alt="Team Logo">
    </div>
  </div>

  <!-- Sold Audio -->
  <audio id="sold_audio" src="{{ url_for('static', filename='playerSold.mp3') }}"></audio>

  <!-- Fireworks Canvas -->
  <canvas id="fireworks_canvas" class="fixed inset-0 pointer-events-none z-40"></canvas>

</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
const fallback_image = "{{ default_image_url }}";
const pollInterval = window.APP_CONFIG.POLL_INTERVAL_MS || 500;
let lastSoldPlayerId = null;
let userInteracted = false;

// Enable audio after user interaction
document.addEventListener('click', () => { userInteracted = true }, { once: true });

async function fetchState() {
  try {
    const res = await fetch("/api/state");
    const json = await res.json();
    return json.state;
  } catch {
    return {};
  }
}

function showSoldModal(player, team, price, logo) {
  const modal = document.getElementById("sold_modal");
  document.getElementById("sold_player_image").src = player.image || fallback_image;
  document.getElementById("sold_team").innerText = `SOLD TO ${team}`;
  document.getElementById("sold_price").innerText = `Final Price: ${price}`;
  const teamLogo = document.getElementById("sold_team_logo");
  if(logo){ teamLogo.src = logo; teamLogo.classList.remove("hidden"); }
  else { teamLogo.classList.add("hidden"); }

  const myConfetti = confetti.create(document.getElementById('fireworks_canvas'), { resize: true, useWorker: true });
  myConfetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

  modal.classList.remove("opacity-0", "pointer-events-none");
  setTimeout(()=> { modal.classList.add("opacity-0", "pointer-events-none"); }, 3500);
}

async function refreshUI() {
  const state = await fetchState();
  if(!state) return;

  const p = state.current_player || {};

  // Player card
  document.getElementById("player_name").innerText = p.name || "---";
  document.getElementById("player_role").innerText = "Role: " + (p.role||"---");
  document.getElementById("player_age").innerText = "Age: " + (p.age||"---");
  document.getElementById("player_base_price").innerText = "Base Price: " + (p.base_price||"---");
  document.getElementById("current_bid_display").innerText = "Highest Bid: " + (state.highest_bid || "---");
  document.getElementById("highest_bidder_display").innerText = "Bid by: " + (state.current_bid?.team_name || "---");
  document.getElementById("player_image").src = p.image || fallback_image;

  // SOLD EVENT
  if(state.sold_to && state.highest_bid && lastSoldPlayerId !== p.id){
    document.getElementById("sold_stamp").classList.add("opacity-100");

    const audio = document.getElementById("sold_audio");
    if(userInteracted){
      audio.currentTime = 0;
      audio.play().catch(()=>{});
    }

    showSoldModal(p, state.sold_to, state.highest_bid, state.sold_team_logo);
    lastSoldPlayerId = p.id;
  } else if(!state.sold_to){
    document.getElementById("sold_stamp").classList.remove("opacity-100");
  }

  /* -------- TEAMS PURCHASE LIST (4 COLUMN TILE WITH LOGO + STATS) -------- */
  const teamsContainer = document.getElementById("teams_container");
  teamsContainer.innerHTML = "";

  state.teams.forEach(team => {
    const div = document.createElement("div");
    div.className = "glass p-3 rounded text-center";

    const logo = (team.logos && team.logos.length > 0)
                 ? team.logos[0]
                 : "https://via.placeholder.com/80";

    const totalSpent = team.players.reduce((a, p) => a + (p.final_price || 0), 0);
    const purseRemaining = team.purse;

    let html = `
      <img src="${logo}" class="w-16 h-16 mx-auto mb-2 rounded-full border shadow">
      <h4 class="font-semibold text-lg mb-1">${team.team_name}</h4>

      <div class="text-sm mb-2">
        <p><span class="font-bold text-green-300">Spent:</span> ${totalSpent}</p>
        <p><span class="font-bold text-yellow-300">Remaining:</span> ${purseRemaining}</p>
      </div>

      <hr class="border-gray-500 mb-2">

      <h5 class="font-semibold text-sm underline mb-1">Purchased Players</h5>
      <ul class="ml-3 text-left list-disc">`;

    if (team.players.length === 0) {
      html += `<li class="text-gray-400 text-sm">No players purchased</li>`;
    } else {
      team.players.forEach(pl => {
        html += `<li>${pl.name} – ${pl.final_price}</li>`;
      });
    }

    html += `</ul>`;
    div.innerHTML = html;

    teamsContainer.appendChild(div);
  });
}

/* ---------------------------------------------------
   ⭐ AUTO ROTATING SPONSOR TILE — NO LOGIC MODIFIED
----------------------------------------------------- */
let sponsorIndex = 0;
const sponsorImages = {{ sponsor_logos | tojson }};

function rotateSponsors() {
  const img = document.getElementById("sponsor_rotating");
  if (!img) return;

  sponsorIndex = (sponsorIndex + 1) % sponsorImages.length;

  img.style.opacity = 0;
  setTimeout(() => {
    img.src = sponsorImages[sponsorIndex];
    img.style.opacity = 1;
  }, 400);
}

setInterval(rotateSponsors, 2500);

refreshUI();
setInterval(refreshUI, pollInterval);

</script>

{% endblock %}
